# 次期アップデート計画 (v0.3.0)

**最終更新**: 2025年8月18日

## お金の使い方機能

プレイヤーが獲得した資金を使って様々なアクションを取れるシステム：

### 想定機能

- **アイテム購入**: ゲーム内で有利になるアイテム
- **アップグレード**: プレイヤーの能力向上
- **設定変更**: 特別なルールやオプションの解放
- **統計強化**: より詳細な分析機能の購入

### 実装検討事項

- ショップメニューの追加
- アイテム効果システム  
- 購入履歴の管理
- バランス調整

### 前提条件

v0.2.0で実装される持続的資金管理システムが必要

**最終更新**: 2025年8月18日

## 今回のアップデート範囲

### 実装順序

1. ✅ **通貨名設定対応** - 完了
2. **持続的資金管理** - 次の実装対象
3. **ベット額選択** - その後の実装対象

## 持続的資金管理

### 基本設計

- **資金永続化**: セッション終了時に残高を `player_data.toml` に保存
- **破産処理**: 資金がベット額を下回る場合の自動調整
- **初期化**: 新規プレイヤーは設定ファイルの初期値を使用

### 実装詳細

```rust
// 新しい構造体
pub struct PlayerData {
    pub current_balance: u32,
    pub total_games: u32,
    pub wins: u32,
    pub losses: u32,
}
```

### ファイル構造

- `player_data.toml`: プレイヤーの残高と統計
- `game_config.toml`: ゲーム設定（既存）

## ベット額選択

### メニュー拡張

新しいメニュー項目:

- ゲーム開始
- **ベット額変更** ← 新規追加
- ヘルプ表示  
- 終了

### ベット選択UI

```doc
現在のベット額: 10np
残高: 1000np

ベット額を選択してください:
> 10np
  25np
  50np 
  100np
  カスタム入力
  戻る
```

### 制限事項

- 最小ベット: 1np
- 最大ベット: 現在残高まで
- カスタム入力の範囲チェック

## 技術メモ

### 既存コードへの影響

- `GameConfig`: ゲーム設定のみ（変更なし）
- `PlayerData`: 新規追加でプレイヤー状態管理
- `MenuChoice`: ベット変更選択肢を追加
- `run_game()`: 資金更新ロジック追加

### ファイル永続化

```toml
# player_data.toml
current_balance = 1250
total_games = 15
wins = 8
losses = 7
```

## 注意事項

- 破産時は最小ベット(1np)に自動調整
- 統計情報は表示のみ（リセット機能は将来実装）
- プレイヤーデータファイルが存在しない場合は初期値で作成
- **初期資金**: プレイヤーは初期資金（例: 1000 nanai）でゲーム開始
- **ベット単位**: 1ラウンドあたりの賭け金（例: 10-100 nanai）を設定可能
- **資金管理**: 勝負結果に応じて持ち金が増減（勝利で+ベット額、敗北で-ベット額）
- **破産防止**: 持ち金がベット額を下回る場合は自動的にベット額を調整
- **永続化**: ゲーム終了時に持ち金とベット設定をオートセーブ

**実装上の考慮点**:

- 持ち金は整数値で管理（小数点計算エラー回避）
- ベット額は持ち金の範囲内に制限（上限: 現在の持ち金、下限: 1 nanai）
- 負の値は許可しない（デバッグとユーザビリティの観点）
- セッション間での継続性を保つため、TOMLファイルで永続化

### 受け入れ基準（アウトカム）

- 起動後にメインメニューが表示され、選択肢で操作できること
- 定石プリセットを選ぶと、その戦略に従ってプレイが進むこと
- 賭け金は増減でき、次ラウンドに反映されること
- 終了選択で安全にゲームを終え、現在状態はオートセーブされること

### データ設計（提案）

**システム構造**:

- MenuChoice enum: {StartGame, SelectStrategy, ChangeBet, ViewBalance, Quit}
- Strategy enum: {Basic, Conservative, Aggressive, Custom}
- PlayerState: {bank: i64, current_bet: i64, strategy: Strategy, games_played: i32}

**持ち金管理詳細**:

- `bank`: 現在の持ち金（np単位、初期値1000）
- `current_bet`: 次のゲームで賭ける金額（デフォルト10、範囲1～bank）
- 勝利時: `bank += current_bet`, 敗北時: `bank -= current_bet`
- 引き分け時: 持ち金変動なし

**セーブシステム**:

- Save format: TOML (既存設定と合わせる)
- 自動保存: PlayerState を `save/player_state.toml` に書く
- バックアップ世代管理: 過去のセーブを広い間隔（例: 10ラウンド毎、1日毎）で `save/backup/` に保存し、履歴を残す

### UI / フロー案（簡潔）

**メニュー構成**:

1. メインメニュー表示: Start / Strategy / Bet / Balance / Quit
2. Strategy ではプリセット一覧を表示し、選択で即時反映
3. Bet では +/- か金額入力で現在ベットを変更（規定範囲チェック）
4. Balance で現在の持ち金、ベット額、プレイ履歴を表示
5. Start でゲームループへ。ラウンド終了時に自動でセーブ。
6. Quit は確認プロンプトの後セーブして終了

**ゲーム中の表示例**:

```doc
現在の持ち金: 1000np
今回のベット: 10np
戦略: 基本戦略
```

**ベット調整の制約**:

- 最小ベット: 1np
- 最大ベット: 現在の持ち金まで
- 持ち金不足時の自動調整: ベット額 = min(設定値, 持ち金)

### 実装メモとファイル変更提案

- `game.rs`: メニュー表示と入力パーサを追加。既存の `run_game` をラウンド単位の呼び出しに分離。
- `config.rs`/`game_config.toml`: Strategy とオートセーブ設定（true/false、保存先）を追加。
- `main.rs`: 起動時に状態ロード→メニュー表示→適切ハンドラへ遷移。
- セーブ処理は失敗をリトライし、失敗時はログを残す（秘密情報不要）。
- バックアップ管理: 定期的（ラウンド数やプレイ時間基準）に `save/backup/player_state_YYYY-MM-DD_HH-MM.toml` 形式で履歴保存。古いバックアップは自動削除（例: 30日経過後）。

#### ゲーム性変更

- サレンダー: Early Surrender（早期サレンダー）の実装。基本戦略に従い、16 vs 9/10/A、15 vs 10 でサレンダー可能にする。

### エッジケースと検討点

- セーブ中にクラッシュした場合の部分書き込み対策（tmpファイルへ書いてから rename）
- 賭け金の下限/上限（負数禁止、銀行残高以上を禁止）
- バックアップファイル管理: ディスク容量制限、古いファイルの自動削除ポリシー、バックアップ失敗時の処理
- マルチスレッドや並列性は当面不要。UI は同期的な CLI 前提。

### テスト案

- メニュー遷移のユニットテスト（選択肢→期待する状態遷移）
- セーブ/ロードの round-trip テスト
- Strategy が変更されたときの挙動スナップショットテスト
- バックアップ世代管理テスト: 指定間隔でのバックアップ作成、古いファイルの自動削除、バックアップからの復元

### 優先度（提案）

1. メニュー式操作（必須）
2. 定石プリセットの選択（必須）
3. 賭け金の変更（必須）
4. サレンダー（Early Surrender 前提）（必須）
5. オートセーブ（重要）
6. Quit 確認と安全な終了（重要）

---

## 【汎用】アップデート実行手順

以下の手順は将来のアップデートでも再利用可能:

## 次期アップデート実行時手順

### 段階的実装方針

次期アップデートは以下の段階を踏まえて実装する:

1. **小単位での実装**: 各機能を最小単位に分割し、1つずつ実装・テスト・動作確認
2. **動作確認の徹底**: 各段階で `cargo run` による動作テスト、既存機能の回帰テストを実行
3. **段階的統合**: 個別機能が安定した後に統合し、全体としての動作を確認
4. **ロールバック準備**: 各段階でgitコミットを作成し、問題発生時は前段階に戻れる状態を維持

### 変更点の一時保存

次期アップデートを実行する際は、以下の手順で変更点を記録する:

1. 実装前に変更予定項目を `docs/update_changes.md` に一時保存
2. 各機能実装時に実際の変更内容を同ファイルに追記
3. アップデート完了後、一般ファイル（README.md、concept.md等）を新バージョンに合わせて全体最適化
4. 変更点は重視せず、全体として自然で一貫した内容になるよう静かに更新
5. `docs/update_changes.md` は実装完了後に削除または archive へ移動

### 次期バージョン固有内容の保存

- **保存対象**: 上記「【次期バージョン固有】」セクションの全内容（要件、データ設計、UI フロー、実装メモ、テスト案、優先度）
- **保存先**: `docs/archive/next_update_v{version}_YYYY-MM-DD.md`
- **保存タイミング**: 実装完了後、新たなnext_updateを作成する前
- **目的**: 将来の類似機能開発時の参考資料、決定プロセスの記録として活用

### 汎用手順の再利用

- **汎用手順**: 「【汎用】アップデート実行手順」部分は将来のアップデートでも使用
- **次回のnext_update.md**: 汎用手順はそのまま残し、「【次期バージョン固有】」セクションのみ新しい内容に差し替える

### 一般ファイル更新方針

- 個別の変更点を強調するのではなく、全体として最適化された内容に調整
- 新機能は自然に統合され、元からあった機能として記述
- ドキュメントの一貫性と読みやすさを最優先とする

---

## v0.3.0 以降の計画 (次々バージョン)

### お金の使い方機能の詳細計画

プレイヤーが獲得した資金を使って様々なアクションを取れるシステム：

#### 次バージョンの想定機能

- **アイテム購入**: ゲーム内で有利になるアイテム
- **アップグレード**: プレイヤーの能力向上
- **設定変更**: 特別なルールやオプションの解放
- **統計強化**: より詳細な分析機能の購入

#### 次バージョン実装検討事項

- ショップメニューの追加
- アイテム効果システム
- 購入履歴の管理
- バランス調整

メモ: これを元に小さな PR に分割できます。まずは v0.2.0 の実装完了後に詳細設計を行う。
