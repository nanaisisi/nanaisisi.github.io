name: WASMæœˆåãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ†ã‚¹ãƒˆ

on:
  push:
    branches: [ main, develop ]
    paths: 
      - 'nanai_wasm_rs/**'
      - '.github/workflows/test-wasm.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'nanai_wasm_rs/**'

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Rustãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Rustãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
        targets: wasm32-unknown-unknown
    
    - name: Rustã‚­ãƒ£ãƒƒã‚·ãƒ¥
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: nanai_wasm_rs
    
    - name: wasm-packã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: cargo install wasm-pack
    
    - name: ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¤‰æ›´
      run: cd nanai_wasm_rs
      
    - name: Cargoãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
      run: cd nanai_wasm_rs && cargo fmt --all -- --check
      
    - name: Clippyãƒªãƒ³ãƒˆ
      run: cd nanai_wasm_rs && cargo clippy -- -D warnings
      
    - name: ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: cd nanai_wasm_rs && cargo test --lib --verbose
      
    - name: WASMãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
      run: cd nanai_wasm_rs && wasm-pack build --target web --out-dir pkg
      
    - name: WASMãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: cd nanai_wasm_rs && wasm-pack test --headless --chrome
      
    - name: æœˆåãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      run: |
        cd nanai_wasm_rs
        echo "å…¨è¨€èªã®æœˆåãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
        cargo test test_all_languages_all_months -- --nocapture
        
    - name: ãƒ†ã‚¹ãƒˆçµæœã®å‡ºåŠ›
      if: always()
      run: |
        echo "ğŸ¯ ãƒ†ã‚¹ãƒˆå®Œäº†!"
        echo "âœ… ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ†ã‚¹ãƒˆ: å®Œäº†"
        echo "âœ… WASMãƒ“ãƒ«ãƒ‰: å®Œäº†" 
        echo "âœ… WASMãƒ†ã‚¹ãƒˆ: å®Œäº†"
        echo "âœ… æœˆåãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§: å®Œäº†"
