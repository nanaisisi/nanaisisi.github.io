name: WASM月名ライブラリテスト

on:
  push:
    branches: [ main, develop ]
    paths: 
      - 'nanai_wasm_rs/**'
      - '.github/workflows/test-wasm.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'nanai_wasm_rs/**'

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Rustテスト
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Rustツールチェーンのセットアップ
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
        targets: wasm32-unknown-unknown
    
    - name: Rustキャッシュ
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: nanai_wasm_rs
    
    - name: wasm-packのインストール
      run: cargo install wasm-pack
    
    - name: 作業ディレクトリの変更
      run: cd nanai_wasm_rs
      
    - name: Cargoフォーマットチェック
      run: cd nanai_wasm_rs && cargo fmt --all -- --check
      
    - name: Clippyリント
      run: cd nanai_wasm_rs && cargo clippy -- -D warnings
      
    - name: ネイティブテスト実行
      run: cd nanai_wasm_rs && cargo test --lib --verbose
      
    - name: WASMビルドテスト
      run: cd nanai_wasm_rs && wasm-pack build --target web --out-dir pkg
      
    - name: WASMテスト実行
      run: cd nanai_wasm_rs && wasm-pack test --headless --chrome
      
    - name: 月名データの整合性チェック
      run: |
        cd nanai_wasm_rs
        echo "全言語の月名データ整合性をチェック中..."
        cargo test test_all_languages_all_months -- --nocapture
        
    - name: テスト結果の出力
      if: always()
      run: |
        echo "🎯 テスト完了!"
        echo "✅ ネイティブテスト: 完了"
        echo "✅ WASMビルド: 完了" 
        echo "✅ WASMテスト: 完了"
        echo "✅ 月名データ整合性: 完了"
